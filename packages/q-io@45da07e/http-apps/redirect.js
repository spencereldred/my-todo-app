var Q=require("q"),URL=require("url2"),Http=require("../http"),Negotiation=require("./negotiate"),HtmlApps=require("./html");exports.PermanentRedirect=function(e,t,n){return function(i){return exports.permanentRedirect(i,e,t,n)}},exports.PermanentRedirectTree=function(e,t){return function(n){return exports.permanentRedirect(n,e,t,!0)}},exports.TemporaryRedirect=function(e,t,n){return function(i){return exports.temporaryRedirect(i,e,t,n)}},exports.TemporaryRedirectTree=function(e,t){return function(n){return exports.temporaryRedirect(n,e,t,!0)}},exports.Redirect=function(e,t,n){return function(i){return exports.redirect(i,e,t,n)}},exports.RedirectTree=function(e,t){return function(n){return exports.redirect(n,e,t,!0)}},exports.permanentRedirect=function(e,t,n){return exports.redirect(e,t,n||301)},exports.permanentRedirectTree=function(e,t,n){return exports.redirect(e,t,n||301,!0)},exports.temporaryRedirect=function(e,t,n){return exports.redirect(e,t,n||307)},exports.temporaryRedirectTree=function(e,t,n){return exports.redirect(e,t,n||307,!0)},exports.redirectTree=function(e,t,n){return exports.redirect(e,t,n,!0)},exports.redirect=function(e,t,n,i){n=n||(e.permanent?301:307),t=URL.resolve(e.url,t),i&&(t=URL.resolve(t,e.pathInfo.replace(/^\//,"")));var r={};r["text/plain"]=exports.redirectText,e.handleHtmlFragmentResponse&&(r["text/html"]=exports.redirectHtml);var a=Negotiation.negotiate(e,r)||exports.redirectText;return a(e,t,n)},exports.redirectText=function(e,t,n){var i=(e.permanent?"Permanent redirect\n":"Temporary redirect\n")+"See: "+t+"\n";return i.length,{status:n,headers:{location:t,"content-type":"text/plain"},body:[i]}},exports.redirectHtml=function(e,t,n){var i=e.permanent?"Permanent redirect":"Temporary redirect";return{status:n,headers:{location:t,"content-type":"text/html"},htmlTitle:i,htmlFragment:{forEach:function(e){e("<h1>"+HtmlApps.escapeHtml(i)+"</h1>\n"),e('<p>See: <a href="'+HtmlApps.escapeHtml(t)+'">'+HtmlApps.escapeHtml(t)+"</a></p>\n")}}}},exports.RedirectTrap=function(e,t){return t=t||20,function(n,i){function r(){Q.fcall(function(){return e(n,i)}).then(function(e){if(exports.isRedirect(e)){if(!a--)throw Error("Maximum redirects.");n.url=e.headers.location,r()}else s.resolve(e)}).fail(s.reject)}var a=t,s=Q.defer();return n=Http.normalizeRequest(n),r(),s.promise}},exports.isRedirect=function(e){return isRedirect[e.status]||!1};var isRedirect={301:!0,302:!0,303:!0,307:!0};