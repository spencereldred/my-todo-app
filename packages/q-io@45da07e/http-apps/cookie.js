function splitHost(e){var t=portRe.exec(e);return t?[t[1],t[2]]:[e,""]}function allHostsContaining(e){var t=splitHost(e),n=t[0],i=t[1];if(ipRe.test(n))return[n+i];if("localhost"===n)return[n+i];for(var t=n.split("."),r=[];t.length>1;)r.push("."+t.join(".")+i),t.shift();return r}function hostContains(e,t){var n=splitHost(e),i=n[0],r=n[1],a=splitHost(t),s=a[0],o=a[1];return r!==o?!1:ipRe.test(i)||ipRe.test(s)?i===s:/^\./.test(i)?s.lastIndexOf(i)===s.length-i.length||i.slice(1)===s:i===s}function pathContains(e,t){return/^\/$/.test(e)?0===t.indexOf(e):t===e||0===t.indexOf(e+"/")}function concat(e){return[].concat.apply([],e)}var Q=require("q"),Cookie=require("../http-cookie");Q.longStackSupport=!0,exports.CookieJar=function(e){var t={};return function(n){if(!n.headers.host)throw Error("Requests must have a host header");var i=allHostsContaining(n.headers.host),r=new Date,a=concat(i.map(function(e){for(var e in t){var i=t[e];for(var a in i){var s=i[a];for(var o in s){var l=s[o];l.expires&&l.expires>r&&delete l[o]}}}return concat(Object.keys(t).map(function(e){if(!hostContains(e,n.headers.host))return[];var i=t[e];return concat(Object.keys(i).map(function(e){if(!pathContains(e,n.path))return[];var t=i[e];return Object.keys(t).map(function(e){return t[e]}).filter(function(e){return e.secure?n.ssl:!0})}))}))}));return a.length&&(n.headers.cookie=a.map(function(e){return Cookie.stringify(e.key,e.value,e)}).join("; ")),Q.when(e.apply(this,arguments),function(e){if(e.headers=e.headers||{},e.headers["set-cookie"]){var i=n.headers.host,r=splitHost(i),a=r[0],s=ipRe.test(a)?i:"."+i;Array.isArray(e.headers["set-cookie"])||(e.headers["set-cookie"]=[e.headers["set-cookie"]]),e.headers["set-cookie"].forEach(function(n){var i=e.headers.date?new Date(e.headers.date):new Date;n=Cookie.parse(n,i),n.host&&!hostContains(s,n.host)&&delete n.host;var r=s||n.host,a=n.path||"/",o=t[r]=t[r]||{},l=o[a]=o[a]||{};l[n.key]=n}),delete e.headers["set-cookie"]}return e})}};var ipRe=/^\d+\.\d+\.\d+\.\d+$/,portRe=/^(.*)(:\d+)$/;