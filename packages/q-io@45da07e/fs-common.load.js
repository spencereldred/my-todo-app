montageDefine("45da07e","fs-common",{dependencies:["q","./fs-boot","./fs-root","./fs-mock"],factory:function(e,t){var n=e("q"),i=e("./fs-boot"),r=e("./fs-root"),a=e("./fs-mock"),s=function(e){return Array.prototype.concat.apply([],e)};t.update=function(e,t){function o(e){var t=this;return e=e||this.ROOT,r(t,e)}function l(e){this.node=e,this.size=e.size}for(var c in i)e[c]=i[c];e.read=function(e,t,i,r){return"object"==typeof t?r=t:"object"==typeof i?(r=i,r.flags=t):(r=r||{},r.flags=t,r.charset=i),r.flags=r.flags||"r",n.when(this.open(e,r),function(e){return e.read()},function(n){throw n.message="Can't read "+e+" because "+n.message,n.path=e,n.flags=t,n.charset=i,n})},e.write=function(e,t,i,r,a){var s=this;return"object"==typeof i?a=i:"object"==typeof r?(a=r,a.flags=i):(a=a||{},a.flags=i,a.charset=r),i=a.flags||"w",-1!==i.indexOf("b")?t instanceof Buffer||(t=new Buffer(t)):t instanceof Buffer&&(i+="b"),a.flags=i,n.when(s.open(e,a),function(e){return n.when(e.write(t),function(){return e.close()})})},e.append=function(e,t,i,r,a){var s=this;return"object"==typeof i?a=i:"object"==typeof r?(a=r,a.flags=i):(a=a||{},a.flags=i,a.charset=r),i=a.flags||"a",t instanceof Buffer&&(i+="b"),a.flags=i,n.when(s.open(e,a),function(e){return n.when(e.write(t),function(){return e.close()})})},e.move=function(e,t){var n=this;return this.rename(e,t).catch(function(i){if(i.crossDevice)return n.copyTree(e,t).then(function(){return n.removeTree(e)});throw i})},e.copy=function(e,t){var i=this;return n.when(i.stat(e),function(r){var a=r.node.mode;return n.all([i.open(e,{flags:"rb"}),i.open(t,{flags:"wb",mode:a})])}).spread(function(e,t){return n.when(e.forEach(function(e){return t.write(e)}),function(){return n.all([e.close(),t.close()])})})},e.copyTree=function(e,t){var i=this;return n.when(i.stat(e),function(r){return r.isFile()?i.copy(e,t):r.isDirectory()?i.exists(t).then(function(a){function s(){return n.when(i.list(e),function(r){return n.all(r.map(function(n){return i.copyTree(i.join(e,n),i.join(t,n))}))})}return a?s():n.when(i.makeDirectory(t,r.node.mode),s)}):r.isSymbolicLink()?i.symbolicCopy(e,t):void 0})},e.listTree=function(e,t){var i=this;e=(e||"")+"",e||(e="."),t=t||function(){return!0};var r=i.stat(e);return n.when(r,function(r){var a=[];try{var s=t(e,r)}catch(o){return n.reject(o)}return n.when(s,function(s){return s&&a.push([e]),null!==s&&r.isDirectory()?n.when(i.list(e),function(n){return a.push.apply(a,n.map(function(n){var r=i.join(e,n);return i.listTree(r,t)})),a}):a})},function(){return[]}).then(n.all).then(s)},e.listDirectoryTree=function(e){return this.listTree(e,function(e,t){return t.isDirectory()})},e.makeTree=function(e,t){e+="";var i=this,r=i.split(e),a=[];return i.isAbsolute(e)&&a.push(r.shift()||i.ROOT),r.reduce(function(e,r){return n.when(e,function(){a.push(r);var e=i.join(a)||".",s=i.makeDirectory(e,t);return n.when(s,null,function(e){if(!e.exists)throw e})})},void 0)},e.removeTree=function(e){var t=this;return n.when(t.statLink(e),function(i){return i.isSymbolicLink()?t.remove(e):i.isDirectory()?t.list(e).then(function(i){return n.all(i.map(function(n){return t.removeTree(t.join(e,n))})).then(function(){return t.removeDirectory(e)})}):t.remove(e)})},e.symbolicCopy=function(e,t,i){var r=this;return n.when(r.relative(t,e),function(e){return r.symbolicLink(t,e,i||"file")})},e.exists=function(e){return n.when(this.stat(e),function(){return!0},function(){return!1})},e.isFile=function(e){return n.when(this.stat(e),function(e){return e.isFile()},function(){return!1})},e.isDirectory=function(e){return n.when(this.stat(e),function(e){return e.isDirectory()},function(){return!1})},e.isSymbolicLink=function(e){return n.when(this.statLink(e),function(e){return e.isSymbolicLink()},function(){return!1})},e.lastModified=function(e){var t=this;return t.stat(e).invoke("lastModified")},e.lastAccessed=function(e){var t=this;return t.stat(e).invoke("lastAccessed")},e.absolute=function(e){return this.isAbsolute(e)?this.normal(e):this.join(t(),e)},e.relative=function(e,t){var i=this;return n.when(this.isDirectory(e),function(n){return n?i.relativeFromDirectory(e,t):i.relativeFromFile(e,t)})},e.relativeFromFile=function(e,t){var n=this;for(e=n.absolute(e),t=n.absolute(t),e=e.split(n.SEPARATORS_RE()),t=t.split(n.SEPARATORS_RE()),e.pop();e.length&&t.length&&t[0]==e[0];)e.shift(),t.shift();for(;e.length;)e.shift(),t.unshift("..");return t.join(n.SEPARATOR)},e.relativeFromDirectory=function(e,n){for(n||(n=e,e=t()),e=this.absolute(e),n=this.absolute(n),e=e.split(this.SEPARATORS_RE()),n=n.split(this.SEPARATORS_RE()),2===e.length&&""===e[1]&&e.pop();e.length&&n.length&&n[0]==e[0];)e.shift(),n.shift();for(;e.length;)e.shift(),n.unshift("..");return n.join(this.SEPARATOR)},e.contains=function(e,t){var n,i;if(e=this.absolute(e),t=this.absolute(t),e=e.split(this.SEPARATORS_RE()),t=t.split(this.SEPARATORS_RE()),2===e.length&&""===e[1]&&e.pop(),e.length>t.length)return!1;for(n=0,i=e.length;i>n&&e[n]===t[n];n++);return n==i},e.reroot=o,e.toObject=function(e){var t=this,i=t.listTree(e||"",function(e,t){return t.isFile()});return n.when(i,function(e){var i={};return n.all(e.map(function(e){return n.when(t.read(e,"rb"),function(t){i[e]=t})})).then(function(){return i})})},e.merge=function(e){var t,i={};return e.forEach(function(e){t=n.when(t,function(){return e.listTree("",function(e,t){return t.isFile()}).then(function(t){return n.all(t.map(function(t){return n.when(e.read(t,"rb"),function(e){i[t]=e})}))})})}),n.when(t,function(){return a(i)})},e.Stats=l;var u=["isDirectory","isFile","isBlockDevice","isCharacterDevice","isSymbolicLink","isFIFO","isSocket"];u.forEach(function(e){l.prototype[e]=function(){return this.node[e]()}}),l.prototype.lastModified=function(){return new Date(this.node.mtime)},l.prototype.lastAccessed=function(){return new Date(this.node.atime)}}}});